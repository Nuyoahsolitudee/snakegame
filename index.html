<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¨ä¹Ÿçš„è´ªåƒè›‡ - æœ€ç»ˆä¿®å¤ç‰ˆ</title>
    <style>
        /* åŸºç¡€å¸ƒå±€ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #ffb3d9 0%, #ff99cc 50%, #ffccee 100%); font-family: 'Comic Sans MS', 'Arial', sans-serif; position: relative; overflow: hidden; }
        
        #game-container { position: relative; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 8px solid #ff69b4; }
        canvas { background: #fff0f5; display: block; border-radius: 10px; }
        
        .ui-panel { margin-top: 20px; display: flex; gap: 15px; }
        .btn { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s; color: white; box-shadow: 0 4px 15px rgba(255,105,180,0.3); }
        .btn-pause { background: #ff69b4; }
        .btn-rank { background: #ff1493; }
        
        /* æ’è¡Œæ¦œå¼¹çª—æ ·å¼ */
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 25px; z-index: 1000; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 5px solid #ff69b4; }
        #leaderboardList { list-style: none; margin: 20px 0; max-height: 300px; overflow-y: auto; }
        
        .leaderboard-item { 
            display: flex; 
            align-items: center; 
            padding: 12px; 
            margin-bottom: 8px; 
            background: #fff0f5; 
            border-radius: 15px; 
        }
        
        /* æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢ CSS ä¼ªå…ƒç´ äº§ç”Ÿ #NaN */
        .player-rank { 
            width: 50px; 
            font-size: 1.5rem; 
            text-align: center; 
            margin-right: 15px; 
            font-weight: bold;
            color: #ff1493;
            display: inline-block;
        }
        .player-rank::before { content: none !important; } /* ç¦ç”¨ä»»ä½•å¯èƒ½å­˜åœ¨çš„å†²çªæ ·å¼ */

        .player-info { flex-grow: 1; }
        .player-name { font-weight: bold; color: #555; }
        .player-score { font-weight: bold; color: #ff1493; font-size: 1.1rem; }

        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; backdrop-filter: blur(3px); }
        .game-status { margin-top: 10px; color: #ff1493; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

    <div id="game-container">
        <div style="text-align: center; margin-bottom: 10px;">
            <span style="font-size: 24px;">åˆ†æ•°: <span id="score">0</span></span>
            <span style="margin-left: 20px; color: #ff1493;">æœ€é«˜: <span id="highScore">0</span></span>
        </div>
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        <div id="gameStatus" class="game-status">æŒ‰æ–¹å‘é”®å¼€å§‹æ¸¸æˆ â†’</div>
    </div>

    <div class="ui-panel">
        <button class="btn btn-pause" onclick="window.togglePause()">â¸ï¸ æš‚åœ/ç»§ç»­</button>
        <button class="btn btn-rank" onclick="window.showLeaderboard()">ğŸ† æ’è¡Œæ¦œ</button>
    </div>

    <div id="overlay"></div>

    <div id="leaderboardModal" class="modal">
        <h2 style="text-align:center; color:#ff1493;">ğŸ€ å…¨çƒæ’è¡Œæ¦œ ğŸ€</h2>
        <ul id="leaderboardList"></ul>
        <button class="btn btn-pause" style="width:100%" onclick="window.closeAllModals()">è¿”å›æ¸¸æˆ</button>
    </div>

    <div id="nameInputModal" class="modal">
        <h3 style="text-align:center; color:#ff1493;">âœ¨ æƒŠäººçš„è¡¨ç°! âœ¨</h3>
        <p style="text-align:center; margin:10px 0;">å¾—åˆ†: <span id="scoreForName">0</span></p>
        <input type="text" id="playerNameInput" placeholder="è¾“å…¥ä½ çš„æ˜µç§°..." maxlength="8" 
               style="width:100%; padding:10px; border-radius:15px; border:2px solid #ffb3d9; margin-bottom:15px; outline:none;">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-rank" style="flex:1" onclick="window.submitScore()">æäº¤åˆ†æ•°</button>
            <button class="btn btn-pause" style="flex:1; background:#ccc;" onclick="window.skipScore()">è·³è¿‡</button>
        </div>
    </div>

    <div id="gameOverModal" class="modal">
        <h2 style="text-align:center; color:#ff1493;">æ¸¸æˆç»“æŸ ğŸ€</h2>
        <p style="text-align:center; margin:15px 0;">æœ¬æ¬¡å¾—åˆ†: <span id="finalScore">0</span></p>
        <button class="btn btn-rank" style="width:100%" onclick="window.restartGame()">å†æ¥ä¸€å±€</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // 1. Firebase åˆå§‹åŒ–
        let db;
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyDLj14o1eUCrpAi3HLVaEZwHJjkTm1Y3Rc",
                authDomain: "snake-leaderboard-6a92c.firebaseapp.com",
                projectId: "snake-leaderboard-6a92c",
                storageBucket: "snake-leaderboard-6a92c.firebasestorage.app",
                messagingSenderId: "399594563906",
                appId: "1:399594563906:web:57686e47280a13ac74c0db"
            };
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch (e) { console.error("Firebase åˆå§‹åŒ–å¤±è´¥", e); }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const highScoreElement = document.getElementById('highScore');
        const overlay = document.getElementById('overlay');
        const gameStatus = document.getElementById('gameStatus');

        let snake = [{x: 10, y: 10}];
        let food = {x: 15, y: 15};
        let dx = 0, dy = 0, score = 0, gameRunning = false, isPaused = false, hasStarted = false;
        let highScore = localStorage.getItem('zhouyeSnakeHighScore') || 0;
        highScoreElement.textContent = highScore;

        window.togglePause = function() {
            if (!hasStarted) return;
            isPaused = !isPaused;
            gameStatus.textContent = isPaused ? 'â¸ï¸ æ¸¸æˆå·²æš‚åœ' : 'ğŸ® æ¸¸æˆè¿›è¡Œä¸­...';
        };

        window.restartGame = function() {
            clearInterval(window.gameLoop);
            snake = [{x: 10, y: 10}]; dx = 0; dy = 0; score = 0;
            scoreElement.textContent = score;
            gameRunning = false; hasStarted = false; isPaused = false;
            generateFood();
            window.closeAllModals();
            draw();
            gameStatus.innerHTML = 'æŒ‰æ–¹å‘é”®å¼€å§‹æ¸¸æˆ â†’';
        };

        window.closeAllModals = function() {
            overlay.style.display = 'none';
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        };

        window.skipScore = function() { window.closeAllModals(); };

        // --- æ ¸å¿ƒä¿®å¤ï¼šæ’è¡Œæ¦œå¥–æ¯æ¸²æŸ“é€»è¾‘ ---
        window.showLeaderboard = async function() {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '<li style="text-align:center; padding:20px;">ğŸ€ æ­£åœ¨åŠ è½½äº‘ç«¯æ•°æ®...</li>';
            overlay.style.display = 'block';
            document.getElementById('leaderboardModal').style.display = 'block';

            if (!db) {
                leaderboardList.innerHTML = '<li style="color:red; text-align:center;">âŒ æ•°æ®åº“æœªè¿æ¥</li>';
                return;
            }

            try {
                const snapshot = await db.collection("scores").orderBy("score", "desc").limit(10).get();
                leaderboardList.innerHTML = '';

                if (snapshot.empty) {
                    leaderboardList.innerHTML = '<li style="text-align:center; padding:20px;">ğŸŒŸ æš‚æ— è®°å½•</li>';
                    return;
                }

                let currentRank = 1; // æ‰‹åŠ¨è®¡æ•°ï¼Œç»ä¸ä¼šå‡ºç° NaN
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    li.className = `leaderboard-item rank-${currentRank}`;
                    
                    // å¥–æ¯é€»è¾‘
                    let trophy = `#${currentRank}`;
                    if (currentRank === 1) trophy = 'ğŸ¥‡';
                    else if (currentRank === 2) trophy = 'ğŸ¥ˆ';
                    else if (currentRank === 3) trophy = 'ğŸ¥‰';

                    li.innerHTML = `
                        <span class="player-rank">${trophy}</span>
                        <div class="player-info">
                            <div class="player-name">${data.name || 'æ— åè‹±é›„'}</div>
                        </div>
                        <span class="player-score">${data.score}åˆ†</span>
                    `;
                    leaderboardList.appendChild(li);
                    currentRank++;
                });
            } catch (error) {
                leaderboardList.innerHTML = '<li style="color:red; text-align:center;">âŒ åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç†</li>';
            }
        };

        window.submitScore = async function() {
            const nameInput = document.getElementById('playerNameInput');
            const name = nameInput.value.trim();
            if (!name) { alert('è¯·è¾“å…¥åå­— ğŸ€'); return; }
            const btn = document.querySelector('#nameInputModal .btn-rank');
            btn.disabled = true;
            btn.textContent = 'æäº¤ä¸­...';
            try {
                await db.collection("scores").add({
                    name: name,
                    score: score,
                    date: firebase.firestore.FieldValue.serverTimestamp()
                });
                window.closeAllModals();
                window.showLeaderboard(); 
            } catch (error) {
                alert("æäº¤å¤±è´¥");
                btn.disabled = false;
                btn.textContent = 'æäº¤åˆ†æ•°';
            }
        };

        // --- æ¸¸æˆå¼•æ“ ---
        function generateFood() {
            food = { x: Math.floor(Math.random() * 20), y: Math.floor(Math.random() * 20) };
            if (snake.some(s => s.x === food.x && s.y === food.y)) generateFood();
        }

        function draw() {
            ctx.fillStyle = '#fff0f5';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            snake.forEach((s, i) => {
                ctx.fillStyle = i === 0 ? '#ff1493' : '#ffb3d9';
                ctx.beginPath();
                ctx.arc(s.x * 20 + 10, s.y * 20 + 10, 9, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.fillStyle = '#ff0040';
            ctx.beginPath();
            ctx.arc(food.x * 20 + 10, food.y * 20 + 10, 8, 0, Math.PI * 2);
            ctx.fill();
        }

        function update() {
            if (isPaused || !gameRunning) return;
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            if (head.x < 0 || head.x >= 20 || head.y < 0 || head.y >= 20 || 
                snake.some(s => s.x === head.x && s.y === head.y)) {
                endGame(); return;
            }
            snake.unshift(head);
            if (head.x === food.x && head.y === food.y) {
                score += 10;
                scoreElement.textContent = score;
                generateFood();
                if (score > highScore) {
                    highScore = score;
                    highScoreElement.textContent = highScore;
                    localStorage.setItem('zhouyeSnakeHighScore', highScore);
                }
            } else { snake.pop(); }
        }

        function endGame() {
            gameRunning = false;
            clearInterval(window.gameLoop);
            document.getElementById('finalScore').textContent = score;
            overlay.style.display = 'block';
            document.getElementById('gameOverModal').style.display = 'block';
            if (score > 0) {
                setTimeout(() => {
                    document.getElementById('gameOverModal').style.display = 'none';
                    document.getElementById('scoreForName').textContent = score;
                    document.getElementById('nameInputModal').style.display = 'block';
                }, 1200);
            }
        }

        document.addEventListener('keydown', (e) => {
            if ([37,38,39,40].includes(e.keyCode)) {
                e.preventDefault();
                if (!gameRunning && !isPaused) {
                    gameRunning = true; hasStarted = true;
                    window.gameLoop = setInterval(() => { update(); draw(); }, 120);
                    gameStatus.textContent = 'ğŸ® æ¸¸æˆè¿›è¡Œä¸­...';
                }
                if (e.keyCode === 37 && dx !== 1) { dx = -1; dy = 0; }
                if (e.keyCode === 38 && dy !== 1) { dx = 0; dy = -1; }
                if (e.keyCode === 39 && dx !== -1) { dx = 1; dy = 0; }
                if (e.keyCode === 40 && dy !== -1) { dx = 0; dy = 1; }
            }
        });

        draw();
    </script>
</body>
</html>